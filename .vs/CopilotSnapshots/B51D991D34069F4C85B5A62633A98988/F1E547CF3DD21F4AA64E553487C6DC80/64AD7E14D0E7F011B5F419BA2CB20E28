/**
 * Script pour corriger les caractères mal encodés dans les fichiers frontend
 * Usage: node scripts/fix-encoding.js
 */

const fs = require('fs');
const path = require('path');

// Répertoires à scanner
const DIRS_TO_SCAN = [
  path.join(__dirname, '..', 'app'),
  path.join(__dirname, '..', 'components'),
  path.join(__dirname, '..', 'lib'),
  path.join(__dirname, '..', 'stores'),
];

// Mapping des mots mal encodés vers les mots corrects
const WORD_REPLACEMENTS = {
  // Mots français courants mal encodés
  'DCpannage': 'Depannage',
  'dCpannage': 'depannage',
  'gColocalisC': 'geolocalise',
  'GColocalisation': 'Geolocalisation',
  'gColocalisation': 'geolocalisation',
  'sCcurisC': 'securise',
  'sCcuritC': 'securite',
  'sCcurita': 'securite',
  'MCcanicien': 'Mecanicien',
  'mCcanicien': 'mecanicien',
  'MCcaniciens': 'Mecaniciens',
  'mCcaniciens': 'mecaniciens',
  'vChicule': 'vehicule',
  'vChicules': 'vehicules',
  'VChicule': 'Vehicule',
  'VChicules': 'Vehicules',
  'ParamCtres': 'Parametres',
  'paramCtres': 'parametres',
  'CrCer': 'Creer',
  'crCer': 'creer',
  'crCC': 'cree',
  'CrCC': 'Cree',
  'utilisC': 'utilise',
  'UtilisC': 'Utilise',
  'rCel': 'reel',
  'RCel': 'Reel',
  'gCnCral': 'general',
  'GCnCral': 'General',
  'rCussi': 'reussi',
  'RCussi': 'Reussi',
  'envoyC': 'envoye',
  'EnvoyC': 'Envoye',
  'terminC': 'termine',
  'TerminC': 'Termine',
  'acceptC': 'accepte',
  'AcceptC': 'Accepte',
  'refusC': 'refuse',
  'RefusC': 'Refuse',
  'annulC': 'annule',
  'AnnulC': 'Annule',
  'dCmarrer': 'demarrer',
  'DCmarrer': 'Demarrer',
  'Cquipe': 'Equipe',
  'Cquipe': 'equipe',
  'prCnom': 'prenom',
  'PrCnom': 'Prenom',
  'numCro': 'numero',
  'NumCro': 'Numero',
  'tClCphone': 'telephone',
  'TClCphone': 'Telephone',
  'adressC': 'adresse',
  'AdressC': 'Adresse',
  'problCme': 'probleme',
  'ProblCme': 'Probleme',
  'systCme': 'systeme',
  'SystCme': 'Systeme',
  'complCtC': 'complete',
  'ComplCtC': 'Complete',
  'terminCe': 'terminee',
  'TerminCe': 'Terminee',
  'dCjC': 'deja',
  'DCjC': 'Deja',
  'DCconnexion': 'Deconnexion',
  'dCconnexion': 'deconnexion',
  'supprimC': 'supprime',
  'SupprimC': 'Supprime',
  'modifiC': 'modifie',
  'ModifiC': 'Modifie',
  'ajoutC': 'ajoute',
  'AjoutC': 'Ajoute',
  'sClectionner': 'selectionner',
  'SClectionner': 'Selectionner',
  'sClectionnC': 'selectionne',
  'SClectionnC': 'Selectionne',
  'dCfinir': 'definir',
  'DCfinir': 'Definir',
  'dCfini': 'defini',
  'DCfini': 'Defini',
  'rCinitialiser': 'reinitialiser',
  'RCinitialiser': 'Reinitialiser',
  'rCinitialisC': 'reinitialise',
  'RCinitialisC': 'Reinitialise',
  'recherchC': 'recherche',
  'RecherchC': 'Recherche',
  'vCrifier': 'verifier',
  'VCrifier': 'Verifier',
  'vCrifiC': 'verifie',
  'VCrifiC': 'Verifie',
  'prCfCrence': 'preference',
  'PrCfCrence': 'Preference',
  
  // Caractères isolés problématiques
  'C ': 'e ',
  ' C': ' e',
};

// Extensions de fichiers à traiter
const EXTENSIONS = ['.tsx', '.ts', '.js', '.jsx'];

// Compteurs
let filesScanned = 0;
let filesModified = 0;
let totalReplacements = 0;

/**
 * Récursivement scanner un répertoire
 */
function scanDirectory(dir) {
  if (!fs.existsSync(dir)) {
    console.log(`Directory not found: ${dir}`);
    return;
  }

  const files = fs.readdirSync(dir);

  for (const file of files) {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      if (file !== 'node_modules' && file !== '.next') {
        scanDirectory(filePath);
      }
    } else if (EXTENSIONS.includes(path.extname(file))) {
      processFile(filePath);
    }
  }
}

/**
 * Traiter un fichier
 */
function processFile(filePath) {
  filesScanned++;
  
  try {
    let content = fs.readFileSync(filePath, 'utf8');
    let originalContent = content;
    let replacementCount = 0;

    // Appliquer les remplacements de mots
    for (const [badWord, goodWord] of Object.entries(WORD_REPLACEMENTS)) {
      const regex = new RegExp(escapeRegex(badWord), 'g');
      const matches = content.match(regex);
      if (matches) {
        replacementCount += matches.length;
        content = content.replace(regex, goodWord);
      }
    }

    // Si des modifications ont été faites
    if (content !== originalContent) {
      fs.writeFileSync(filePath, content, 'utf8');
      filesModified++;
      totalReplacements += replacementCount;
      console.log(`✓ Fixed: ${path.relative(process.cwd(), filePath)} (${replacementCount} replacements)`);
    }
  } catch (error) {
    console.error(`✗ Error processing ${filePath}: ${error.message}`);
  }
}

/**
 * Échapper les caractères spéciaux pour regex
 */
function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Main
 */
function main() {
  console.log('='.repeat(60));
  console.log('Fixing encoding issues in frontend files...');
  console.log('='.repeat(60));
  console.log('');

  // Scanner les répertoires
  for (const dir of DIRS_TO_SCAN) {
    const dirName = path.basename(dir);
    console.log(`Scanning ${dirName} directory...`);
    scanDirectory(dir);
  }

  console.log('');
  console.log('='.repeat(60));
  console.log('Summary:');
  console.log(`  Files scanned: ${filesScanned}`);
  console.log(`  Files modified: ${filesModified}`);
  console.log(`  Total replacements: ${totalReplacements}`);
  console.log('='.repeat(60));

  if (filesModified > 0) {
    console.log('\n✓ Encoding issues fixed successfully!');
  } else {
    console.log('\n✓ No encoding issues found.');
  }
}

main();
