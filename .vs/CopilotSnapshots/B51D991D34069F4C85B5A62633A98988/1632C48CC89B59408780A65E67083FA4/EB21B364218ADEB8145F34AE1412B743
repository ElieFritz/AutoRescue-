'use client';

import { useEffect, useRef, useState } from 'react';

interface MarkerData {
  position: [number, number];
  type: 'user' | 'garage' | 'mechanic';
  data?: any;
}

interface MapContainerProps {
  center: [number, number];
  zoom?: number;
  markers?: MarkerData[];
  onGarageSelect?: (garage: any) => void;
  showMechanicRoute?: boolean;
  mechanicPosition?: [number, number];
}

export function MapContainer({
  center,
  zoom = 14,
  markers = [],
  onGarageSelect,
}: MapContainerProps) {
  const mapRef = useRef<any>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [isLoaded, setIsLoaded] = useState(false);
  const [L, setL] = useState<any>(null);

  // Load Leaflet dynamically
  useEffect(() => {
    const loadLeaflet = async () => {
      if (typeof window !== 'undefined') {
        const leaflet = await import('leaflet');
        
        // Add CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);
        
        // Fix default icons
        delete (leaflet.Icon.Default.prototype as any)._getIconUrl;
        leaflet.Icon.Default.mergeOptions({
          iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
          iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        });
        
        setL(leaflet);
        setIsLoaded(true);
      }
    };
    
    loadLeaflet();
  }, []);

  // Initialize map
  useEffect(() => {
    if (!isLoaded || !L || !containerRef.current || mapRef.current) return;

    mapRef.current = L.map(containerRef.current).setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '� OpenStreetMap contributors',
    }).addTo(mapRef.current);

    return () => {
      if (mapRef.current) {
        mapRef.current.remove();
        mapRef.current = null;
      }
    };
  }, [isLoaded, L]);

  // Update center
  useEffect(() => {
    if (mapRef.current && L) {
      mapRef.current.setView(center, zoom);
    }
  }, [center, zoom, L]);

  // Update markers
  useEffect(() => {
    if (!mapRef.current || !L) return;

    // Clear existing markers
    mapRef.current.eachLayer((layer: any) => {
      if (layer instanceof L.Marker) {
        mapRef.current?.removeLayer(layer);
      }
    });

    // Create icons
    const userIcon = L.divIcon({
      className: 'custom-marker',
      html: `
        <div style="
          width: 24px;
          height: 24px;
          background: #3b82f6;
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        "></div>
      `,
      iconSize: [24, 24],
      iconAnchor: [12, 12],
    });

    const garageIcon = L.divIcon({
      className: 'custom-marker',
      html: `
        <div style="
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, #10b981, #059669);
          border-radius: 50%;
          border: 3px solid white;
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
        </div>
      `,
      iconSize: [32, 32],
      iconAnchor: [16, 16],
    });

    // Add markers
    markers.forEach((marker) => {
      const icon = marker.type === 'user' ? userIcon : garageIcon;
      const m = L.marker(marker.position, { icon }).addTo(mapRef.current!);

      if (marker.type === 'garage' && marker.data && onGarageSelect) {
        const popupContent = `
          <div style="min-width: 150px; font-family: system-ui;">
            <strong>${marker.data.garage_name || marker.data.name || 'Garage'}</strong>
            <p style="margin: 4px 0; color: #666; font-size: 12px;">
              ${marker.data.distance_km ? marker.data.distance_km.toFixed(1) + ' km' : ''}
            </p>
            <button 
              onclick="window.selectGarage('${marker.data.garage_id || marker.data.id}')"
              style="
                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                width: 100%;
                margin-top: 8px;
                font-size: 12px;
              "
            >
              Selectionner
            </button>
          </div>
        `;
        m.bindPopup(popupContent);
      }
    });

    // Global handler for garage selection
    if (onGarageSelect) {
      (window as any).selectGarage = (id: string) => {
        const garage = markers.find(m => m.data?.garage_id === id || m.data?.id === id)?.data;
        if (garage) {
          onGarageSelect(garage);
        }
      };
    }
  }, [markers, onGarageSelect, L]);

  if (!isLoaded) {
    return (
      <div className="h-full w-full rounded-xl bg-muted flex items-center justify-center">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>
    );
  }

  return <div ref={containerRef} className="h-full w-full rounded-xl" />;
}
