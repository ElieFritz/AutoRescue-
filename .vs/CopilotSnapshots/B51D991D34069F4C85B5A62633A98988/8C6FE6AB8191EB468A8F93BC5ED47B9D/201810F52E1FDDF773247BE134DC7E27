/**
 * Script pour corriger les caractères mal encodés dans les fichiers frontend
 * Usage: node scripts/fix-encoding.js
 */

const fs = require('fs');
const path = require('path');

// Répertoire à scanner
const FRONTEND_DIR = path.join(__dirname, '..', 'app');
const COMPONENTS_DIR = path.join(__dirname, '..', 'components');

// Mapping des caractères mal encodés vers les caractères corrects
const REPLACEMENTS = {
  // Caractères encodés en UTF-8 mais lus comme Latin-1
  'Ã©': 'e',      // é
  'Ã¨': 'e',      // è
  'Ã ': 'a',      // à
  'Ã¹': 'u',      // ù
  'Ã´': 'o',      // ô
  'Ã®': 'i',      // î
  'Ã§': 'c',      // ç
  'Ãª': 'e',      // ê
  'Ã¢': 'a',      // â
  'Ã»': 'u',      // û
  'Ã¯': 'i',      // ï
  'Ã«': 'e',      // ë
  'Ã¼': 'u',      // ü
  'Ã¶': 'o',      // ö
  'Ã¤': 'a',      // ä
  'Ã±': 'n',      // ñ
  'Å"': 'oe',     // œ
  'Ã¦': 'ae',     // æ
  
  // Caractères de remplacement Unicode
  'ï¿½': '',      // Caractère de remplacement
  '\ufffd': '',   // Caractère de remplacement Unicode
  
  // Guillemets et apostrophes mal encodés
  'â€™': "'",     // '
  'â€œ': '"',     // "
  'â€': '"',      // "
  'â€¦': '...',   // …
  'â€"': '-',     // –
  'â€"': '-',     // —
  
  // Accents français - version simplifiée (sans accents)
  'é': 'e',
  'è': 'e', 
  'ê': 'e',
  'ë': 'e',
  'à': 'a',
  'â': 'a',
  'ä': 'a',
  'ù': 'u',
  'û': 'u',
  'ü': 'u',
  'î': 'i',
  'ï': 'i',
  'ô': 'o',
  'ö': 'o',
  'ç': 'c',
  'É': 'E',
  'È': 'E',
  'Ê': 'E',
  'À': 'A',
  'Â': 'A',
  'Ù': 'U',
  'Û': 'U',
  'Î': 'I',
  'Ô': 'O',
  'Ç': 'C',
};

// Extensions de fichiers à traiter
const EXTENSIONS = ['.tsx', '.ts', '.js', '.jsx'];

// Compteurs
let filesScanned = 0;
let filesModified = 0;
let totalReplacements = 0;

/**
 * Récursivement scanner un répertoire
 */
function scanDirectory(dir) {
  if (!fs.existsSync(dir)) {
    console.log(`Directory not found: ${dir}`);
    return;
  }

  const files = fs.readdirSync(dir);

  for (const file of files) {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);

    if (stat.isDirectory()) {
      // Ignorer node_modules et .next
      if (file !== 'node_modules' && file !== '.next') {
        scanDirectory(filePath);
      }
    } else if (EXTENSIONS.includes(path.extname(file))) {
      processFile(filePath);
    }
  }
}

/**
 * Traiter un fichier
 */
function processFile(filePath) {
  filesScanned++;
  
  try {
    let content = fs.readFileSync(filePath, 'utf8');
    let originalContent = content;
    let replacementCount = 0;

    // Appliquer les remplacements
    for (const [badChar, goodChar] of Object.entries(REPLACEMENTS)) {
      const regex = new RegExp(escapeRegex(badChar), 'g');
      const matches = content.match(regex);
      if (matches) {
        replacementCount += matches.length;
        content = content.replace(regex, goodChar);
      }
    }

    // Si des modifications ont été faites
    if (content !== originalContent) {
      fs.writeFileSync(filePath, content, 'utf8');
      filesModified++;
      totalReplacements += replacementCount;
      console.log(`✓ Fixed: ${path.relative(process.cwd(), filePath)} (${replacementCount} replacements)`);
    }
  } catch (error) {
    console.error(`✗ Error processing ${filePath}: ${error.message}`);
  }
}

/**
 * Échapper les caractères spéciaux pour regex
 */
function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Main
 */
function main() {
  console.log('='.repeat(60));
  console.log('Fixing encoding issues in frontend files...');
  console.log('='.repeat(60));
  console.log('');

  // Scanner les répertoires
  console.log('Scanning app directory...');
  scanDirectory(FRONTEND_DIR);
  
  console.log('Scanning components directory...');
  scanDirectory(COMPONENTS_DIR);

  console.log('');
  console.log('='.repeat(60));
  console.log('Summary:');
  console.log(`  Files scanned: ${filesScanned}`);
  console.log(`  Files modified: ${filesModified}`);
  console.log(`  Total replacements: ${totalReplacements}`);
  console.log('='.repeat(60));

  if (filesModified > 0) {
    console.log('\n✓ Encoding issues fixed successfully!');
  } else {
    console.log('\n✓ No encoding issues found.');
  }
}

main();
